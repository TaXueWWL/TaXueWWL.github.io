
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>学点儿gRPC-从入门到放弃 | 朝·闻·道</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="SnoWalker">
    

    <meta name="keywords" content="gRPC">
    <meta name="description" content="微服务如火如荼的当下，各种服务框架层出不穷。Dubbo、SpringCloud在国内Java后端微服务领域目前占据大部分份额。
但是随着云原生愈发普及，具备跨语言、高性能特性的RPC通信框架横空出世，其中gRPC与Thrift是其中的佼佼者。

本文我们将视角集中在gRPC这RPC框架。

gRPC 是Google开源的高性能、通用的RPC框架。客户端与服务端约定接口调用， 可以在各种环境中运行">
<meta property="og:type" content="article">
<meta property="og:title" content="学点儿gRPC-从入门到放弃">
<meta property="og:url" content="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/index.html">
<meta property="og:site_name" content="朝·闻·道">
<meta property="og:description" content="微服务如火如荼的当下，各种服务框架层出不穷。Dubbo、SpringCloud在国内Java后端微服务领域目前占据大部分份额。
但是随着云原生愈发普及，具备跨语言、高性能特性的RPC通信框架横空出世，其中gRPC与Thrift是其中的佼佼者。

本文我们将视角集中在gRPC这RPC框架。

gRPC 是Google开源的高性能、通用的RPC框架。客户端与服务端约定接口调用， 可以在各种环境中运行">
<meta property="og:image" content="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/grpc_server.png">
<meta property="og:image" content="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/grpc-03-04.png">
<meta property="og:image" content="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/grpc_client_flow.png">
<meta property="og:image" content="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/grpcvsrest.png">
<meta property="og:image" content="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/image-20200207140210335.png">
<meta property="og:image" content="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/demo.png">
<meta property="og:updated_time" content="2022-03-13T04:35:29.755Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="学点儿gRPC-从入门到放弃">
<meta name="twitter:description" content="微服务如火如荼的当下，各种服务框架层出不穷。Dubbo、SpringCloud在国内Java后端微服务领域目前占据大部分份额。
但是随着云原生愈发普及，具备跨语言、高性能特性的RPC通信框架横空出世，其中gRPC与Thrift是其中的佼佼者。

本文我们将视角集中在gRPC这RPC框架。

gRPC 是Google开源的高性能、通用的RPC框架。客户端与服务端约定接口调用， 可以在各种环境中运行">
<meta name="twitter:image" content="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/grpc_server.png">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="朝·闻·道" title="朝·闻·道"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="朝·闻·道">朝·闻·道</a></h1>
				<h2 class="blog-motto">SnoWalker&#39;s Blog</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/index.html">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/old/index.html">旧版</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:wuwenliang.net">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2022/03/12/学点儿gRPC-从入门到放弃/" title="学点儿gRPC-从入门到放弃" itemprop="url">学点儿gRPC-从入门到放弃</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="SnoWalker" target="_blank" itemprop="author">SnoWalker</a>
		
  <p class="article-time">
    <time datetime="2022-03-12T13:31:45.000Z" itemprop="datePublished"> 发表于 2022-03-12</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC特性介绍"><span class="toc-number">1.</span> <span class="toc-text">gRPC特性介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC的线程模型是怎样的？"><span class="toc-number">2.</span> <span class="toc-text">gRPC的线程模型是怎样的？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC客户端如何请求服务端"><span class="toc-number">3.</span> <span class="toc-text">gRPC客户端如何请求服务端?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC性能到底有多强？"><span class="toc-number">4.</span> <span class="toc-text">gRPC性能到底有多强？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC-Java-服务调用实战"><span class="toc-number">5.</span> <span class="toc-text">gRPC-Java 服务调用实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#grpc-demo父工程"><span class="toc-number">6.</span> <span class="toc-text">grpc-demo父工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#grpc-demo-sdk"><span class="toc-number">7.</span> <span class="toc-text">grpc-demo-sdk</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml"><span class="toc-number">7.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写proto文件，定义服务接口"><span class="toc-number">7.2.</span> <span class="toc-text">编写proto文件，定义服务接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译打包grpc-demo-sdk工程"><span class="toc-number">7.3.</span> <span class="toc-text">编译打包grpc-demo-sdk工程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写服务端grpc-server-demo"><span class="toc-number">8.</span> <span class="toc-text">编写服务端grpc-server-demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml-1"><span class="toc-number">8.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写OrderServiceImpl实现核心业务逻辑"><span class="toc-number">8.2.</span> <span class="toc-text">编写OrderServiceImpl实现核心业务逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端启动类OrderServerBoot"><span class="toc-number">8.3.</span> <span class="toc-text">服务端启动类OrderServerBoot</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写客户端grpc-client-demo"><span class="toc-number">9.</span> <span class="toc-text">编写客户端grpc-client-demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml-2"><span class="toc-number">9.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写客户端服务调用代理OrderClientAgent"><span class="toc-number">9.2.</span> <span class="toc-text">编写客户端服务调用代理OrderClientAgent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写客户端启动类"><span class="toc-number">9.3.</span> <span class="toc-text">编写客户端启动类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">10.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#首先编译打包sdk"><span class="toc-number">10.1.</span> <span class="toc-text">首先编译打包sdk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动服务端"><span class="toc-number">10.2.</span> <span class="toc-text">启动服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动客户端"><span class="toc-number">10.3.</span> <span class="toc-text">启动客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#观察服务端日志"><span class="toc-number">10.4.</span> <span class="toc-text">观察服务端日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">11.</span> <span class="toc-text">小结</span></a></li></ol>
		
		</div>
		
		<blockquote>
<p>微服务如火如荼的当下，各种服务框架层出不穷。Dubbo、SpringCloud在国内Java后端微服务领域目前占据大部分份额。</p>
<p>但是随着云原生愈发普及，具备跨语言、高性能特性的RPC通信框架横空出世，其中gRPC与Thrift是其中的佼佼者。</p>
</blockquote>
<p>本文我们将视角集中在gRPC这RPC框架。</p>
<blockquote>
<p>gRPC 是Google开源的高性能、通用的RPC框架。客户端与服务端约定接口调用， 可以在各种环境中运行，具有跨语言特性， 适合构建分布式、微服务应用。</p>
</blockquote>
<p>个人认为，gRPC最为杀手锏的特性就是“跨语言”，其次才是高性能。</p>
<p>它的跨语言特性体现在，通过定义IDL（接口定义语言），隔离了不同编程语言之间的差异，对IDL进行编译后，生成对应编程语言的nativeCode，让开发者能够集中注意在实现业务需求上，而不需要花费额外的精力在语言层面上。</p>
<blockquote>
<p>官网的一张图能够很好的体现这个特点</p>
</blockquote>
<p><img src="/2022/03/12/学点儿gRPC-从入门到放弃/grpc_server.png" alt="gRPC多语言"></p>
<a id="more"></a>
<h2 id="gRPC特性介绍"><a href="#gRPC特性介绍" class="headerlink" title="gRPC特性介绍"></a>gRPC特性介绍</h2><blockquote>
<p>gRPC具备以下特性</p>
</blockquote>
<ul>
<li><p>性能优异：</p>
<ol>
<li><p>它采用Proto Buffer作序列化传输媒介， 对比JSON与XML有数倍提升。</p>
</li>
<li><p>采用HTTP2协议， 对头部信息（header）压缩， 对连接进行复用，能够减少TCP连接次数。</p>
</li>
<li><p>针对Java语言，gRPC底层采用Netty作为NIO处理框架， 性能强劲。</p>
</li>
</ol>
</li>
<li>多语言支持，多客户端接入， 支持C++/GO/Ruby等语言。</li>
<li>支持负载均衡、跟踪、健康检查和认证。</li>
</ul>
<h2 id="gRPC的线程模型是怎样的？"><a href="#gRPC的线程模型是怎样的？" class="headerlink" title="gRPC的线程模型是怎样的？"></a>gRPC的线程模型是怎样的？</h2><blockquote>
<p>笔者主力语言为Java，因此我们讲解也集中在Java的实现上。</p>
</blockquote>
<p>gRPC的Java实现，服务端底层采用了Netty作为核心处理框架，因此其线程模型核心也是遵循了 Netty 的线程分工原则。</p>
<p>协议层消息的接收和编解码由 Netty 的 I/O(NioEventLoop) 线程负责, 应用层的处理由应用线程负责，防止由于应用处理耗时而阻塞 Netty 的 I/O 线程。</p>
<blockquote>
<p>Netty线程模型是基于NIO的Reactor模式。</p>
</blockquote>
<p><img src="/2022/03/12/学点儿gRPC-从入门到放弃/grpc-03-04.png" alt="gRPC-Java线程模型"></p>
<blockquote>
<p>Netty是基于NIO构建的通信框架。</p>
</blockquote>
<p>在 Java NIO 中最重要的概念就是多路复用器 Selector，它是 Java NIO 编程的基础。Selector提供了选择已经就绪的任务的能力。</p>
<blockquote>
<p>简单来讲，Selector 会不断地轮询注册在其上的 Channel，如果某个 Channel 上面有新的 TCP 连接接入、读和写事件，这个 Channel 就处于就绪状态，会被 Selector 轮询出来，然后通过SelectionKey 可以获取就绪 Channel 的集合，进行后续的 I/O 操作。</p>
</blockquote>
<p>一般来说，一个 I/O 线程会聚合一个 Selector，一个 Selector 可以同时注册 N 个 Channel, 这样单个</p>
<p>I/O 线程就可以同时并发处理多个客户端连接。</p>
<p>又由于 I/O 操作是非阻塞的，因此也不会受限于网络速度和对方端点的处理时延，可靠性和效率都得到了很大提升。</p>
<h2 id="gRPC客户端如何请求服务端"><a href="#gRPC客户端如何请求服务端" class="headerlink" title="gRPC客户端如何请求服务端?"></a>gRPC客户端如何请求服务端?</h2><blockquote>
<p>作为RPC框架，至少有客户端和服务端两个角色，对于gRPC而言，客户端请求服务端的调用过程如图所示。</p>
</blockquote>
<p><img src="/2022/03/12/学点儿gRPC-从入门到放弃/grpc_client_flow.png" alt="客户端请求服务端"></p>
<p>具体过程：</p>
<ul>
<li>【Stub生成】客户端生成Stub ，通过Stub发起 RPC远程服务调用 ；</li>
<li>【负载均衡】客户端获取服务端的地址信息（列表），使用默认的 LoadBalancer 策略，选择一个具体的 gRPC 服务端进行调用；</li>
<li>【建立链接】如果客户端与服务端之间没有可用的连接，则创建 NettyClientTransport 和 NettyClientHandler，建立 HTTP/2 连接；</li>
<li>【客户端请求序列化】对请求使用 PB（Protobuf）序列化，并通过 HTTP/2 Stream 发送给 gRPC 服务端；</li>
<li>【服务端反序列化】服务端接收到响应之后，使用 PB（Protobuf）做反序列化。</li>
<li>【请求响应】回调 GrpcFuture 的 set(Response) 方法，唤醒阻塞的客户端调用线程，获取 RPC 响应数据。</li>
</ul>
<h2 id="gRPC性能到底有多强？"><a href="#gRPC性能到底有多强？" class="headerlink" title="gRPC性能到底有多强？"></a>gRPC性能到底有多强？</h2><blockquote>
<p>没有对比就没有发言权。</p>
</blockquote>
<p>在不同的操作系统，不同请求数量下，对gRPC与Rest请求进行对比的结论如下：</p>
<p><img src="/2022/03/12/学点儿gRPC-从入门到放弃/grpcvsrest.png" alt=""></p>
<blockquote>
<p>官网也给出了权威性的比对，具体比对gRPC+ProtoBuf与Http+JSON方式请求的差异。</p>
</blockquote>
<p><a href="https://github.com/plutov/benchmark-grpc-protobuf-vs-http-json" target="_blank" rel="external">官方性能比对结果</a></p>
<p><img src="/2022/03/12/学点儿gRPC-从入门到放弃/image-20200207140210335.png" alt=""></p>
<p><strong>实测结果显示GRpc的通讯方案, 性能有32%的提升, 资源占用降低30%左右。</strong></p>
<h2 id="gRPC-Java-服务调用实战"><a href="#gRPC-Java-服务调用实战" class="headerlink" title="gRPC-Java 服务调用实战"></a>gRPC-Java 服务调用实战</h2><blockquote>
<p>按照惯例，我们提供一个简单的订单案例展示gRPC在实际开发中如何使用。</p>
<p>该案例在实际中的意义为：提供一个报价服务，客户端发送下单请求到服务端进行报价，服务端对用户报价单进行汇总计算，并提供查询接口供客户端查询。</p>
<p>主要提供批量下单及查询用户订单能力。</p>
</blockquote>
<p>流程图大致如下：</p>
<p><img src="/2022/03/12/学点儿gRPC-从入门到放弃/demo.png" alt="流程图"></p>
<p>工程结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">|==&gt; grpc-demo			   父级工程， 管理依赖相关</div><div class="line">     |==&gt;grpc-demo-sdk     通用jar依赖，生成protobuf对象与gRPC Service，供提供方与调用方使用</div><div class="line">     |==&gt;grpc-server-demo  服务端，提供下单及订单查询服务</div><div class="line">     |==&gt;grpc-client-demo  客户端，负责调用gRPC服务</div></pre></td></tr></table></figure>
<h2 id="grpc-demo父工程"><a href="#grpc-demo父工程" class="headerlink" title="grpc-demo父工程"></a>grpc-demo父工程</h2><blockquote>
<p>父工程相对比较简单，管理了子工程及依赖版本。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.snowalker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>grpc-server-demo<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>grpc-client-demo<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>grpc-demo-sdk<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">grpc-version</span>&gt;</span>1.44.1<span class="tag">&lt;/<span class="name">grpc-version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-netty-shaded<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="grpc-demo-sdk"><a href="#grpc-demo-sdk" class="headerlink" title="grpc-demo-sdk"></a>grpc-demo-sdk</h2><blockquote>
<p>grpc-demo-sdk是较为关键的公共依赖，主要基于proto对服务进行定义，生成java代码并打包供服务提供方与消费方使用。</p>
</blockquote>
<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><blockquote>
<p>sdk的pom文件如下：</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.snowalker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>grpc-demo-sdk<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-demo-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-netty-shaded<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/proto<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>proto<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">extension</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:3.19.1:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">pluginArtifact</span>&gt;</span>io.grpc:protoc-gen-grpc-java:1.43.1:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">pluginArtifact</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>重点关注一下plugin，我们使用protobuf-maven-plugin作为protobuf的编译工具，有了该插件，我们在执行mvn clean compile命令时便可以实现将proto编译为java代码的目的。</p>
<p>同样，执行mvn clean package命令可以实现将proto编译为java代码并打包为jar包的目的。</p>
<p>可以说是极为方便了。</p>
</blockquote>
<h3 id="编写proto文件，定义服务接口"><a href="#编写proto文件，定义服务接口" class="headerlink" title="编写proto文件，定义服务接口"></a>编写proto文件，定义服务接口</h3><blockquote>
<p>编写OrderService.proto，定义服务接口，主要定义了查询用户订单，批量下单接口，及对应的各种实体和枚举。</p>
</blockquote>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">syntax = <span class="string">"proto3"</span>;</div><div class="line"></div><div class="line"><span class="keyword">option</span> java_multiple_files = <span class="literal">true</span>;</div><div class="line"><span class="keyword">option</span> java_package = <span class="string">"com.snowalker.grpc.sdk"</span>;</div><div class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">"OrderServiceProto"</span>;</div><div class="line"></div><div class="line"><span class="comment">// 订单服务IDL定义</span></div><div class="line"><span class="class"><span class="keyword">service</span> <span class="title">OrderService</span> </span>&#123;</div><div class="line">  <span class="comment">// 查询用户订单列表</span></div><div class="line">  <span class="function"><span class="keyword">rpc</span> queryUserOrders (QueryUserOrderRequest) <span class="keyword">returns</span> (QueryUserOrderResponse) &#123;</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // 下单</div><div class="line">  <span class="keyword">rpc</span> placeOrder(PlaceOrderRequest) <span class="keyword">returns</span> (PlaceOrderRequestResponse) &#123;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 查询订单请求</div><div class="line">message QueryUserOrderRequest &#123;</div><div class="line">  int32 userId = 1;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 查询订单响应</span></div><div class="line"><span class="class"><span class="keyword">message</span> <span class="title">QueryUserOrderResponse</span> </span>&#123;</div><div class="line">  <span class="built_in">int32</span> userId = <span class="number">1</span>;</div><div class="line">  <span class="built_in">string</span> totalPrice = <span class="number">2</span>;</div><div class="line">  <span class="keyword">repeated</span> UserOrder userOrder = <span class="number">3</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 批量下单请求</span></div><div class="line"><span class="class"><span class="keyword">message</span> <span class="title">PlaceOrderRequest</span> </span>&#123;</div><div class="line">  <span class="built_in">int32</span> userId = <span class="number">1</span>;</div><div class="line">  <span class="keyword">repeated</span> PlaceUserOrderParam placeUserOrderParam = <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 批量下单响应</span></div><div class="line"><span class="class"><span class="keyword">message</span> <span class="title">PlaceOrderRequestResponse</span> </span>&#123;</div><div class="line">  <span class="built_in">int32</span> userId = <span class="number">1</span>;</div><div class="line">  ResultCode resultCode = <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 订单查询详情</span></div><div class="line"><span class="class"><span class="keyword">message</span> <span class="title">UserOrder</span> </span>&#123;</div><div class="line">  <span class="built_in">int64</span> orderId = <span class="number">1</span>;</div><div class="line">  <span class="built_in">string</span> orderPrice = <span class="number">2</span>;</div><div class="line">  <span class="built_in">string</span> orderAmount = <span class="number">3</span>;</div><div class="line">  <span class="built_in">int32</span> productId = <span class="number">4</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 下单请求详情</span></div><div class="line"><span class="class"><span class="keyword">message</span> <span class="title">PlaceUserOrderParam</span> </span>&#123;</div><div class="line">  <span class="built_in">string</span> orderPrice = <span class="number">1</span>;    <span class="comment">// 单价</span></div><div class="line">  <span class="built_in">string</span> orderAmount = <span class="number">2</span>;   <span class="comment">// 数量</span></div><div class="line">  <span class="built_in">int32</span> productId = <span class="number">3</span>;      <span class="comment">// 商品id</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 结果枚举：成功/失败</span></div><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ResultCode</span> </span>&#123;</div><div class="line">  SUCCESS = <span class="number">0</span>;</div><div class="line">  FAILURE = <span class="number">1</span>;</div><div class="line">  UNKNOWN = <span class="number">2</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>如下为protobuf与java、c++对应关系，</p>
<p>更多protobuf的使用，请参考官网文档：<a href="https://developers.google.com/protocol-buffers/docs/javatutorial" target="_blank" rel="external">https://developers.google.com/protocol-buffers/docs/javatutorial</a></p>
</blockquote>
<table border="1" cellpadding="0" cellspacing="0"><tbody><tr><td style="vertical-align:top;"> <p><strong>protobuf</strong><strong>属性</strong></p> </td><td style="vertical-align:top;"> <p><strong>C++</strong><strong>属性</strong></p> </td><td style="vertical-align:top;"> <p><strong>java</strong><strong>属性</strong></p> </td><td style="vertical-align:top;"> <p><strong>备注</strong></p> </td></tr><tr><td style="vertical-align:top;"> <p>double</p> </td><td style="vertical-align:top;"> <p>double</p> </td><td style="vertical-align:top;"> <p>double</p> </td><td style="vertical-align:top;"> <p>固定8个字节</p> </td></tr><tr><td style="vertical-align:top;"> <p>float</p> </td><td style="vertical-align:top;"> <p>float</p> </td><td style="vertical-align:top;"> <p>float</p> </td><td style="vertical-align:top;"> <p>固定4个字节</p> </td></tr><tr><td style="vertical-align:top;"> <p>int32</p> </td><td style="vertical-align:top;"> <p>int32</p> </td><td style="vertical-align:top;"> <p>int32</p> </td><td style="vertical-align:top;"> <p>使用变长编码，对于负数编码效率较低，如果经常使用负数，建议使用sint32</p> </td></tr><tr><td style="vertical-align:top;"> <p>int64</p> </td><td style="vertical-align:top;"> <p>int64</p> </td><td style="vertical-align:top;"> <p>int64</p> </td><td style="vertical-align:top;"> <p>使用变长编码，对于负数编码效率较低，如果经常使用负数，建议使用sint64</p> </td></tr><tr><td style="vertical-align:top;"> <p>uint32</p> </td><td style="vertical-align:top;"> <p>uint32</p> </td><td style="vertical-align:top;"> <p>int</p> </td><td style="vertical-align:top;"> <p>使用变长编码</p> </td></tr><tr><td style="vertical-align:top;"> <p>uint64</p> </td><td style="vertical-align:top;"> <p>uint64</p> </td><td style="vertical-align:top;"> <p>long</p> </td><td style="vertical-align:top;"> <p>使用变长编码</p> </td></tr><tr><td style="vertical-align:top;"> <p>sint32</p> </td><td style="vertical-align:top;"> <p>int32</p> </td><td style="vertical-align:top;"> <p>int</p> </td><td style="vertical-align:top;"> <p>采用zigzag压缩，对负数编码效率比int32高</p> </td></tr><tr><td style="vertical-align:top;"> <p>sint64</p> </td><td style="vertical-align:top;"> <p>int64</p> </td><td style="vertical-align:top;"> <p>long</p> </td><td style="vertical-align:top;"> <p>采用zigzag压缩，对负数编码效率比int64高</p> </td></tr><tr><td style="vertical-align:top;"> <p>fixed32</p> </td><td style="vertical-align:top;"> <p>uint32</p> </td><td style="vertical-align:top;"> <p>int</p> </td><td style="vertical-align:top;"> <p>总是4字节，如果数据&gt;2^28，编码效率高于unit32</p> </td></tr><tr><td style="vertical-align:top;"> <p>fixed64</p> </td><td style="vertical-align:top;"> <p>uint64</p> </td><td style="vertical-align:top;"> <p>long</p> </td><td style="vertical-align:top;"> <p>总是8字节，如果数据&gt;2^56，编码效率高于unit32</p> </td></tr><tr><td style="vertical-align:top;"> <p>sfixed32</p> </td><td style="vertical-align:top;"> <p>int32</p> </td><td style="vertical-align:top;"> <p>int</p> </td><td style="vertical-align:top;"> <p>总是4字节</p> </td></tr><tr><td style="vertical-align:top;"> <p>sfixed64</p> </td><td style="vertical-align:top;"> <p>int64</p> </td><td style="vertical-align:top;"> <p>long</p> </td><td style="vertical-align:top;"> <p>总是8字节</p> </td></tr><tr><td style="vertical-align:top;"> <p>bool</p> </td><td style="vertical-align:top;"> <p>bool</p> </td><td style="vertical-align:top;"> <p>boolean</p> </td><td style="vertical-align:top;"> <p>&nbsp;</p> </td></tr><tr><td style="vertical-align:top;"> <p>string</p> </td><td style="vertical-align:top;"> <p>string</p> </td><td style="vertical-align:top;"> <p>String</p> </td><td style="vertical-align:top;"> <p>一个字符串必须是utf-8编码或者7-bit的ascii编码的文本</p> </td></tr><tr><td style="vertical-align:top;"> <p>bytes</p> </td><td style="vertical-align:top;"> <p>string</p> </td><td style="vertical-align:top;"> <p>ByteString</p> </td><td style="vertical-align:top;"> <p>可能包含任意顺序的字节数据</p> </td></tr></tbody></table>

<h3 id="编译打包grpc-demo-sdk工程"><a href="#编译打包grpc-demo-sdk工程" class="headerlink" title="编译打包grpc-demo-sdk工程"></a>编译打包grpc-demo-sdk工程</h3><blockquote>
<p>编写完proto文件后，对grpc-demo-sdk工程执行打包编译</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean install -DskipTests</div></pre></td></tr></table></figure>
<h2 id="编写服务端grpc-server-demo"><a href="#编写服务端grpc-server-demo" class="headerlink" title="编写服务端grpc-server-demo"></a>编写服务端grpc-server-demo</h2><blockquote>
<p>接着编写服务端</p>
</blockquote>
<h3 id="pom-xml-1"><a href="#pom-xml-1" class="headerlink" title="pom.xml"></a>pom.xml</h3><blockquote>
<p>服务端pom内容如下</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.snowalker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-server-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-demo-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.snowalker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>除了lombok外，其余的依赖由grpc-demo-sdk间接引入。</p>
<h3 id="编写OrderServiceImpl实现核心业务逻辑"><a href="#编写OrderServiceImpl实现核心业务逻辑" class="headerlink" title="编写OrderServiceImpl实现核心业务逻辑"></a>编写OrderServiceImpl实现核心业务逻辑</h3><blockquote>
<p>首先编写OrderServiceImpl，实现核心的下单与查订单业务逻辑。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> snowalker</div><div class="line"> * <span class="doctag">@version</span> 1.0</div><div class="line"> * <span class="doctag">@date</span> 2022/3/12 23:47</div><div class="line"> * <span class="doctag">@className</span></div><div class="line"> * <span class="doctag">@desc</span></div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">extends</span> <span class="title">OrderServiceGrpc</span>.<span class="title">OrderServiceImplBase</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(OrderServiceImpl.class.getName());</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Integer, LinkedList&lt;UserOrder&gt;&gt; USER_MEMORY_ORDER_BOOK = Maps.newConcurrentMap();</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * &lt;pre&gt;</div><div class="line">	 * 查询用户订单列表</div><div class="line">	 * &lt;/pre&gt;</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> request</div><div class="line">	 * <span class="doctag">@param</span> responseObserver</div><div class="line">	 */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryUserOrders</span><span class="params">(QueryUserOrderRequest request, StreamObserver&lt;QueryUserOrderResponse&gt; responseObserver)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> userId = request.getUserId();</div><div class="line">		<span class="comment">// 查询订单</span></div><div class="line">		List&lt;UserOrder&gt; orders = USER_MEMORY_ORDER_BOOK.getOrDefault(userId, Lists.newLinkedList());</div><div class="line"></div><div class="line">		<span class="comment">// 计算总价</span></div><div class="line">		String totalPrice = calculateTotalPrice(orders);</div><div class="line"></div><div class="line">		<span class="comment">// 组装response</span></div><div class="line">		QueryUserOrderResponse queryUserOrderResponse = QueryUserOrderResponse.newBuilder()</div><div class="line">				.setUserId(userId)</div><div class="line">				.addAllUserOrder(orders)</div><div class="line">				.setTotalPrice(totalPrice)</div><div class="line">				.build();</div><div class="line"></div><div class="line">		logger.info(<span class="string">"[Server] queryUserOrders, request:"</span> + request.toString() + <span class="string">"\n"</span> + <span class="string">"response:"</span> + queryUserOrderResponse.toString());</div><div class="line"></div><div class="line">		<span class="comment">// 响应</span></div><div class="line">		responseObserver.onNext(queryUserOrderResponse);</div><div class="line">		responseObserver.onCompleted();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">calculateTotalPrice</span><span class="params">(List&lt;UserOrder&gt; orders)</span> </span>&#123;</div><div class="line">		Optional&lt;BigDecimal&gt; count = orders.stream()</div><div class="line">				.map(order -&gt; <span class="keyword">new</span> BigDecimal(order.getOrderAmount()).multiply(<span class="keyword">new</span> BigDecimal(order.getOrderPrice())))</div><div class="line">				.reduce(BigDecimal::add);</div><div class="line">		<span class="keyword">return</span> count.orElseGet(() -&gt; BigDecimal.ZERO).toPlainString();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * &lt;pre&gt;</div><div class="line">	 * 下单</div><div class="line">	 * &lt;/pre&gt;</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> request</div><div class="line">	 * <span class="doctag">@param</span> responseObserver</div><div class="line">	 */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">placeOrder</span><span class="params">(PlaceOrderRequest request, StreamObserver&lt;PlaceOrderRequestResponse&gt; responseObserver)</span> </span>&#123;</div><div class="line"></div><div class="line">		ThreadLocalRandom orderIdGenerator = ThreadLocalRandom.current();</div><div class="line"></div><div class="line">		PlaceOrderRequestResponse.Builder placeOrderRequestResponse = PlaceOrderRequestResponse.newBuilder();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> userId = request.getUserId();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (request.getPlaceUserOrderParamCount() &lt;= <span class="number">0</span>) &#123;</div><div class="line">			placeOrderRequestResponse.setUserId(userId).setResultCode(ResultCode.FAILURE).build();</div><div class="line">			responseObserver.onNext(placeOrderRequestResponse.build());</div><div class="line">			responseObserver.onCompleted();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 获取用户订单列表</span></div><div class="line">		LinkedList&lt;UserOrder&gt; userOrderList = USER_MEMORY_ORDER_BOOK.getOrDefault(userId, Lists.newLinkedList());</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (userOrderList.size() == <span class="number">0</span>) &#123;</div><div class="line">			USER_MEMORY_ORDER_BOOK.put(userId, Lists.newLinkedList());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">int</span> orderId = getOrderId(orderIdGenerator);</div><div class="line"></div><div class="line">		<span class="comment">// 本次订单</span></div><div class="line">		List&lt;UserOrder&gt; userOrders = request.getPlaceUserOrderParamList().stream().map(</div><div class="line">				param -&gt; UserOrder.newBuilder()</div><div class="line">						.setOrderId(orderId)</div><div class="line">						.setOrderAmount(param.getOrderAmount())</div><div class="line">						.setOrderPrice(param.getOrderPrice())</div><div class="line">						.setProductId(param.getProductId())</div><div class="line">						.build()).collect(Collectors.toList());</div><div class="line"></div><div class="line">		<span class="comment">// 追加订单列表</span></div><div class="line">		userOrderList.addAll(userOrders);</div><div class="line"></div><div class="line">		USER_MEMORY_ORDER_BOOK.put(userId, userOrderList);</div><div class="line"></div><div class="line">		<span class="comment">// 响应</span></div><div class="line">		responseObserver.onNext(placeOrderRequestResponse.setUserId(userId).setResultCode(ResultCode.SUCCESS).build());</div><div class="line">		responseObserver.onCompleted();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getOrderId</span><span class="params">(ThreadLocalRandom orderIdGenerator)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> orderId = orderIdGenerator.nextInt();</div><div class="line">		<span class="keyword">if</span> (orderId &lt; <span class="number">0</span>) &#123;</div><div class="line">			orderId *= -<span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> orderId;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的代码是完整的代码，读者可以自行复制并直接使用，简单解释下代码：</p>
<ol>
<li>placeOrder为下单服务，核心逻辑就是解析用户下单请求PlaceOrderRequest，将用户订单增量添加到内存订单簿USER_MEMORY_ORDER_BOOK中。<ol>
<li>核心的数据结构为：<em>Map<integer, linkedlist<userorder="">&gt;</integer,></em>，在实战中，通用会持久化订单到redis、MySQL、RocksDB等存储设施中；</li>
</ol>
</li>
<li>queryUserOrders为查询订单服务，核心逻辑为解析用户查询订单请求QueryUserOrderRequest，取出用户id（userId），并在订单簿中匹配当前用户的订单列表。</li>
</ol>
<h3 id="服务端启动类OrderServerBoot"><a href="#服务端启动类OrderServerBoot" class="headerlink" title="服务端启动类OrderServerBoot"></a>服务端启动类OrderServerBoot</h3><blockquote>
<p>有了服务端业务代码之后，重点关注一下服务端启动类的编写。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> snowalker</div><div class="line"> * <span class="doctag">@version</span> 1.0</div><div class="line"> * <span class="doctag">@date</span> 2022/3/12 23:46</div><div class="line"> * <span class="doctag">@desc</span> 服务端启动类</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServerBoot</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(OrderServerBoot.class.getName());</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Server server;</div><div class="line"></div><div class="line">	<span class="meta">@SneakyThrows</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startServer</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> serverPort = <span class="number">10880</span>;</div><div class="line">		server = ServerBuilder.forPort(serverPort)</div><div class="line">				.addService(<span class="keyword">new</span> OrderServiceImpl())</div><div class="line">				.build();</div><div class="line">		server.start();</div><div class="line"></div><div class="line">		logger.info(<span class="string">"OrderServerBoot started, listening on:"</span> + serverPort);</div><div class="line"></div><div class="line">		<span class="comment">// 优雅停机</span></div><div class="line">		addGracefulShowdownHook();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addGracefulShowdownHook</span><span class="params">()</span> </span>&#123;</div><div class="line">		Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="comment">// Use stderr here since the logger may have been reset by its JVM shutdown hook.</span></div><div class="line">			System.err.println(<span class="string">"*** shutting down gRPC server since JVM is shutting down"</span>);</div><div class="line">			OrderServerBoot.<span class="keyword">this</span>.stop();</div><div class="line">			System.err.println(<span class="string">"*** server shut down"</span>);</div><div class="line">		&#125;));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 服务关闭</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (server != <span class="keyword">null</span>) &#123;</div><div class="line">			server.shutdown();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 由于 grpc 库使用守护线程，因此在主线程上等待终止。</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">blockUntilShutdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (server != <span class="keyword">null</span>) &#123;</div><div class="line">			server.awaitTermination();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@SneakyThrows</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		OrderServerBoot boot = <span class="keyword">new</span> OrderServerBoot();</div><div class="line">		<span class="comment">// 启动服务</span></div><div class="line">		boot.startServer();</div><div class="line">		<span class="comment">// 主线程等待终止</span></div><div class="line">		boot.blockUntilShutdown();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>解释下代码：</p>
<ul>
<li>核心逻辑为main方法，首先定义OrderServerBoot，通过startServer()启动服务，并通过blockUntilShutdown()让主线程等待终止。</li>
<li><strong>startServer()</strong> 方法核心逻辑，启动一个服务端进程并绑定到对应的端口，这里使用10880，并添加优雅停机钩子；</li>
<li><strong>stop()</strong> 逻辑为服务关闭逻辑；</li>
<li><strong>blockUntilShutdown()</strong> ：由于grpc使用守护线程，因此需要在主线程上等待终止。</li>
</ul>
<h2 id="编写客户端grpc-client-demo"><a href="#编写客户端grpc-client-demo" class="headerlink" title="编写客户端grpc-client-demo"></a>编写客户端grpc-client-demo</h2><blockquote>
<p>有了服务端，我们接着看下客户端工程的编写。</p>
</blockquote>
<h3 id="pom-xml-2"><a href="#pom-xml-2" class="headerlink" title="pom.xml"></a>pom.xml</h3><blockquote>
<p>客户端pom如下</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.snowalker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-client-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-demo-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.snowalker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>与服务端相同，除了lombok外，其余的依赖由grpc-demo-sdk间接引入。</p>
<h3 id="编写客户端服务调用代理OrderClientAgent"><a href="#编写客户端服务调用代理OrderClientAgent" class="headerlink" title="编写客户端服务调用代理OrderClientAgent"></a>编写客户端服务调用代理OrderClientAgent</h3><blockquote>
<p>客户端调用远程服务，需要借助proto生成的stub桩，作为客户端而言，常常会对该stub进行包装，这里我们通过一个OrderClientAgent作为stub的包装类。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderClientAgent</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(OrderClientAgent.class.getName());</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ManagedChannel channel;</div><div class="line"></div><div class="line">	<span class="comment">// 客户端请求服务端的桩</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> OrderServiceGrpc.OrderServiceBlockingStub orderServiceBlockingStub;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OrderClientAgent</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>(ManagedChannelBuilder.forAddress(host, port)</div><div class="line">				<span class="comment">//使用非安全机制传输,默认情况下，通道是安全的（通过SSLTLS）</span></div><div class="line">				.usePlaintext()</div><div class="line">				.build());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	OrderClientAgent(ManagedChannel channel) &#123;</div><div class="line">		<span class="keyword">this</span>.channel = channel;</div><div class="line">		orderServiceBlockingStub = OrderServiceGrpc.newBlockingStub(channel);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		channel.shutdown().awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 下单</div><div class="line">	 * <span class="doctag">@param</span> request</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> PlaceOrderRequestResponse <span class="title">placeOrder</span><span class="params">(PlaceOrderRequest request)</span> </span>&#123;</div><div class="line">		logger.info(<span class="string">"client placeOrder start. request:"</span> + request.toString());</div><div class="line">		PlaceOrderRequestResponse placeOrderRequestResponse;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			placeOrderRequestResponse = orderServiceBlockingStub.placeOrder(request);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> placeOrderRequestResponse;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 订单查询</div><div class="line">	 * <span class="doctag">@param</span> request</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> QueryUserOrderResponse <span class="title">queryOrders</span><span class="params">(QueryUserOrderRequest request)</span> </span>&#123;</div><div class="line">		logger.info(<span class="string">"client queryOrders start. request:"</span> + request.toString());</div><div class="line">		QueryUserOrderResponse queryUserOrderResponse;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			queryUserOrderResponse = orderServiceBlockingStub.queryUserOrders(request);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> queryUserOrderResponse;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简单解释下代码：</p>
<ul>
<li>通过构造方法传入主机名，服务端端口，构造客户端与服务端间的链接通过ManagedChannel</li>
<li>通过OrderServiceGrpc.newBlockingStub(channel)生成客户端访问的stub实例，这里使用的是阻塞型Stub，即同步等待服务端返回所有结果；</li>
<li>placeOrder方法通过stub访问服务端的下单服务；</li>
<li>queryOrders方法通过stub访问服务端的查询订单服务。</li>
</ul>
<h3 id="编写客户端启动类"><a href="#编写客户端启动类" class="headerlink" title="编写客户端启动类"></a>编写客户端启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> snowalker</div><div class="line"> * <span class="doctag">@version</span> 1.0</div><div class="line"> * <span class="doctag">@date</span> 2022/3/12 23:56</div><div class="line"> * <span class="doctag">@desc</span> 客户端启动类</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderClientBoot</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(OrderClientBoot.class.getName());</div><div class="line"></div><div class="line">   <span class="meta">@SneakyThrows</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">      <span class="keyword">int</span> port = <span class="number">10880</span>;</div><div class="line">      OrderClientAgent orderClientAgent = <span class="keyword">new</span> OrderClientAgent(<span class="string">"127.0.0.1"</span>, port);</div><div class="line"></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">         <span class="keyword">int</span> userId = <span class="number">10086</span>;</div><div class="line"></div><div class="line">         <span class="comment">// 下单</span></div><div class="line">         doPlaceOrder(orderClientAgent, userId);</div><div class="line"></div><div class="line">         <span class="comment">// 查订单</span></div><div class="line">         doQueryOrder(orderClientAgent, userId);</div><div class="line"></div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">         orderClientAgent.shutdown();</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doQueryOrder</span><span class="params">(OrderClientAgent orderClientAgent, <span class="keyword">int</span> userId)</span> </span>&#123;</div><div class="line">      QueryUserOrderRequest queryUserOrderRequest = QueryUserOrderRequest.newBuilder()</div><div class="line">            .setUserId(userId)</div><div class="line">            .buildPartial();</div><div class="line">      QueryUserOrderResponse queryUserOrderResponse = orderClientAgent.queryOrders(queryUserOrderRequest);</div><div class="line">      logger.info(<span class="string">"client queryOrders end. response:"</span> + queryUserOrderResponse.toString());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doPlaceOrder</span><span class="params">(OrderClientAgent orderClientAgent, <span class="keyword">int</span> userId)</span> </span>&#123;</div><div class="line"></div><div class="line">      PlaceUserOrderParam orderParam0 = PlaceUserOrderParam.newBuilder()</div><div class="line">            .setProductId(<span class="number">1</span>)</div><div class="line">            .setOrderAmount(<span class="string">"15.00"</span>)</div><div class="line">            .setOrderPrice(<span class="string">"12.50"</span>)</div><div class="line">            .build();</div><div class="line"></div><div class="line">      PlaceUserOrderParam orderParam1 = PlaceUserOrderParam.newBuilder()</div><div class="line">            .setProductId(<span class="number">2</span>)</div><div class="line">            .setOrderAmount(<span class="string">"2.00"</span>)</div><div class="line">            .setOrderPrice(<span class="string">"10.00"</span>)</div><div class="line">            .build();</div><div class="line"></div><div class="line">      PlaceOrderRequest placeOrderRequest = PlaceOrderRequest.newBuilder()</div><div class="line">            .setUserId(userId)</div><div class="line">            .addAllPlaceUserOrderParam(Lists.newArrayList(orderParam0, orderParam1))</div><div class="line">            .buildPartial();</div><div class="line"></div><div class="line">      PlaceOrderRequestResponse placeOrderRequestResponse = orderClientAgent.placeOrder(placeOrderRequest);</div><div class="line">      logger.info(<span class="string">"client placeOrder end. response:"</span> + placeOrderRequestResponse.toString() + <span class="string">",resultCode:"</span> + placeOrderRequestResponse.getResultCode());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重点关注main方法：</p>
<ul>
<li>声明服务端端口，这里注意务必与服务端暴露服务端口保持一致；</li>
<li>通过构造方法创建客户端访问服务端的agent实例，即上面提到的OrderClientAgent；</li>
<li>通过实例化的OrderClientAgent执行下单、查询订单操作</li>
<li>调用完成后，关闭OrderClientAgent，关闭客户端与服务端之间的链接。</li>
<li><strong>实际生产中，客户端往往会与服务端保持链接开启，而不会频繁创建、关闭服务。</strong></li>
</ul>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><blockquote>
<p>sdk、客户端、服务端均编写完毕，我们启动服务进行测试。</p>
</blockquote>
<h3 id="首先编译打包sdk"><a href="#首先编译打包sdk" class="headerlink" title="首先编译打包sdk"></a>首先编译打包sdk</h3><p>在grpc-demo-sdk根目录下执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean install -DskipTests</div></pre></td></tr></table></figure>
<h3 id="启动服务端"><a href="#启动服务端" class="headerlink" title="启动服务端"></a>启动服务端</h3><p>运行OrderServerBoot的main方法，日志打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">三月 13, 2022 10:50:29 上午 OrderServerBoot startServer</div><div class="line">信息: OrderServerBoot started, listening on:10880</div></pre></td></tr></table></figure>
<h3 id="启动客户端"><a href="#启动客户端" class="headerlink" title="启动客户端"></a>启动客户端</h3><p>运行OrderClientBoot的main方法，启动客户端并发起服务调用</p>
<blockquote>
<p>首先进行下单：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">三月 13, 2022 10:54:57 上午 agent.OrderClientAgent placeOrder</div><div class="line">信息: client placeOrder start. request:userId: 10086</div><div class="line">placeUserOrderParam &#123;</div><div class="line">  orderPrice: &quot;12.50&quot;</div><div class="line">  orderAmount: &quot;15.00&quot;</div><div class="line">  productId: 1</div><div class="line">&#125;</div><div class="line">placeUserOrderParam &#123;</div><div class="line">  orderPrice: &quot;10.00&quot;</div><div class="line">  orderAmount: &quot;2.00&quot;</div><div class="line">  productId: 2</div><div class="line">&#125;</div><div class="line"></div><div class="line">三月 13, 2022 10:54:58 上午 OrderClientBoot doPlaceOrder</div><div class="line">信息: client placeOrder end. response:userId: 10086</div><div class="line">,resultCode:SUCCESS</div></pre></td></tr></table></figure>
<p>下单成功，接着发起查询订单操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">三月 13, 2022 12:20:55 下午 agent.OrderClientAgent queryOrders</div><div class="line">信息: client queryOrders start. request:userId: 10086</div><div class="line"></div><div class="line">三月 13, 2022 12:20:55 下午 OrderClientBoot doQueryOrder</div><div class="line">信息: client queryOrders end. response:userId: 10086</div><div class="line">totalPrice: &quot;207.5000&quot;</div><div class="line">userOrder &#123;</div><div class="line">  orderId: 510807688</div><div class="line">  orderPrice: &quot;12.50&quot;</div><div class="line">  orderAmount: &quot;15.00&quot;</div><div class="line">  productId: 1</div><div class="line">&#125;</div><div class="line">userOrder &#123;</div><div class="line">  orderId: 510807688</div><div class="line">  orderPrice: &quot;10.00&quot;</div><div class="line">  orderAmount: &quot;2.00&quot;</div><div class="line">  productId: 2</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，下单成功，且通过查询订单调用，将用户10086下的两个订单获取到了。</p>
<h3 id="观察服务端日志"><a href="#观察服务端日志" class="headerlink" title="观察服务端日志"></a>观察服务端日志</h3><blockquote>
<p>服务端日志打印如下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">三月 13, 2022 12:20:55 下午 service.OrderServiceImpl queryUserOrders</div><div class="line">信息: [Server] queryUserOrders, request:userId: 10086</div><div class="line"></div><div class="line">response:userId: 10086</div><div class="line">totalPrice: &quot;207.5000&quot;</div><div class="line">userOrder &#123;</div><div class="line">  orderId: 510807688</div><div class="line">  orderPrice: &quot;12.50&quot;</div><div class="line">  orderAmount: &quot;15.00&quot;</div><div class="line">  productId: 1</div><div class="line">&#125;</div><div class="line">userOrder &#123;</div><div class="line">  orderId: 510807688</div><div class="line">  orderPrice: &quot;10.00&quot;</div><div class="line">  orderAmount: &quot;2.00&quot;</div><div class="line">  productId: 2</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务端完成下单之后，对用户订单总价值进行计算</p>
<blockquote>
<p>totalPrice = 12.5<em>15 + 10 </em>2 = 207.5</p>
</blockquote>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文我们对gRPC进行了如下介绍：</p>
<ul>
<li>gRPC特性介绍</li>
<li>gRPC-java线程模型</li>
<li>gRPC客户端请求服务端方式</li>
<li>gRPC与REST性能比对</li>
</ul>
<p>并通过一个完整的demo展示了基于gRPC实现的报价服务，全景展示了gRPC在实战中如何进行使用。</p>
<p>到此我们对gRPC应当有了大致的了解和认知，后续我们将继续从入门到放弃的学习之路。</p>
<p>预告：接下来将对gRPC的底层机制进行讲解，并会为我们的报价服务添加服务发现能力，整合Nacos提供服务注册与发现，降低客户端与服务端之间的耦合，敬请期待。</p>
<p><hr><br>版权声明：<br><br>原创不易，洗文可耻。除非注明，本博文章均为原创，转载请以链接形式标明本文地址。<br></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/gRPC/">gRPC</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/gRPC/">gRPC</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/" data-title="学点儿gRPC-从入门到放弃 | 朝·闻·道" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2022/03/17/gRPC从入门到放弃之为gRPC添加服务发现/" title="gRPC从入门到放弃之为gRPC添加服务发现">
  <strong>上一篇：</strong><br/>
  <span>
  gRPC从入门到放弃之为gRPC添加服务发现</span>
</a>
</div>


<div class="next">
<a href="/2022/03/10/学点儿金融知识-撮合交易那些事儿/"  title="学点儿金融知识-撮合交易那些事儿">
 <strong>下一篇：</strong><br/> 
 <span>学点儿金融知识-撮合交易那些事儿
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2022/03/12/学点儿gRPC-从入门到放弃/" data-title="学点儿gRPC-从入门到放弃" data-url="http://wuwenliang.net/2022/03/12/学点儿gRPC-从入门到放弃/"></div>
</section>




</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC特性介绍"><span class="toc-number">1.</span> <span class="toc-text">gRPC特性介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC的线程模型是怎样的？"><span class="toc-number">2.</span> <span class="toc-text">gRPC的线程模型是怎样的？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC客户端如何请求服务端"><span class="toc-number">3.</span> <span class="toc-text">gRPC客户端如何请求服务端?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC性能到底有多强？"><span class="toc-number">4.</span> <span class="toc-text">gRPC性能到底有多强？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC-Java-服务调用实战"><span class="toc-number">5.</span> <span class="toc-text">gRPC-Java 服务调用实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#grpc-demo父工程"><span class="toc-number">6.</span> <span class="toc-text">grpc-demo父工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#grpc-demo-sdk"><span class="toc-number">7.</span> <span class="toc-text">grpc-demo-sdk</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml"><span class="toc-number">7.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写proto文件，定义服务接口"><span class="toc-number">7.2.</span> <span class="toc-text">编写proto文件，定义服务接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译打包grpc-demo-sdk工程"><span class="toc-number">7.3.</span> <span class="toc-text">编译打包grpc-demo-sdk工程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写服务端grpc-server-demo"><span class="toc-number">8.</span> <span class="toc-text">编写服务端grpc-server-demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml-1"><span class="toc-number">8.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写OrderServiceImpl实现核心业务逻辑"><span class="toc-number">8.2.</span> <span class="toc-text">编写OrderServiceImpl实现核心业务逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端启动类OrderServerBoot"><span class="toc-number">8.3.</span> <span class="toc-text">服务端启动类OrderServerBoot</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写客户端grpc-client-demo"><span class="toc-number">9.</span> <span class="toc-text">编写客户端grpc-client-demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml-2"><span class="toc-number">9.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写客户端服务调用代理OrderClientAgent"><span class="toc-number">9.2.</span> <span class="toc-text">编写客户端服务调用代理OrderClientAgent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写客户端启动类"><span class="toc-number">9.3.</span> <span class="toc-text">编写客户端启动类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">10.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#首先编译打包sdk"><span class="toc-number">10.1.</span> <span class="toc-text">首先编译打包sdk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动服务端"><span class="toc-number">10.2.</span> <span class="toc-text">启动服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动客户端"><span class="toc-number">10.3.</span> <span class="toc-text">启动客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#观察服务端日志"><span class="toc-number">10.4.</span> <span class="toc-text">观察服务端日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">11.</span> <span class="toc-text">小结</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/CouchDB/" title="CouchDB">CouchDB<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/DDD/" title="DDD">DDD<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/ELK-Stack/" title="ELK-Stack">ELK-Stack<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/HTTPS/" title="HTTPS">HTTPS<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/JDK-concurrent/" title="JDK-concurrent">JDK-concurrent<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/JDK源码解析/" title="JDK源码解析">JDK源码解析<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>37</sup></a></li>
		  
		
		  
			<li><a href="/categories/KindEditor/" title="KindEditor">KindEditor<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/MIT/" title="MIT">MIT<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Redis/" title="Redis">Redis<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/SSO/" title="SSO">SSO<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/SpringCloud/" title="SpringCloud">SpringCloud<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Spring扩展点/" title="Spring扩展点">Spring扩展点<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/TCC-Transaction源码解析/" title="TCC-Transaction源码解析">TCC-Transaction源码解析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Tomcat/" title="Tomcat">Tomcat<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/auth/" title="auth">auth<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/disruptor/" title="disruptor">disruptor<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/docker/" title="docker">docker<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/gRPC/" title="gRPC">gRPC<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/hexo/" title="hexo">hexo<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/kubernates/" title="kubernates">kubernates<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/maven/" title="maven">maven<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/mybatis/" title="mybatis">mybatis<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/mysql/" title="mysql">mysql<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/nginx/" title="nginx">nginx<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/nginx-负载均衡/" title="nginx, 负载均衡">nginx, 负载均衡<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/spring-boot/" title="spring-boot">spring-boot<sup>38</sup></a></li>
		  
		
		  
			<li><a href="/categories/springboot/" title="springboot">springboot<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/web/" title="web">web<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/与你同行/" title="与你同行">与你同行<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/专题-分布式/" title="专题-分布式">专题-分布式<sup>19</sup></a></li>
		  
		
		  
			<li><a href="/categories/从零学Netty/" title="从零学Netty">从零学Netty<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/代理模式-工作总结-入职感受/" title="代理模式,工作总结,入职感受">代理模式,工作总结,入职感受<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/分布式-Dubbo/" title="分布式 Dubbo">分布式 Dubbo<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/单例模式/" title="单例模式">单例模式<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/实战分布式/" title="实战分布式">实战分布式<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/年度总结/" title="年度总结">年度总结<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/架构/" title="架构">架构<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/汇总盘点推荐/" title="汇总盘点推荐">汇总盘点推荐<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/爬虫/" title="爬虫">爬虫<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/电话面试/" title="电话面试">电话面试<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/研磨Kafka/" title="研磨Kafka">研磨Kafka<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/自己写分布式组件系列/" title="自己写分布式组件系列">自己写分布式组件系列<sup>17</sup></a></li>
		  
		
		  
			<li><a href="/categories/跟我学RocketMQ/" title="跟我学RocketMQ">跟我学RocketMQ<sup>25</sup></a></li>
		  
		
		  
			<li><a href="/categories/跟我学zookeeper/" title="跟我学zookeeper">跟我学zookeeper<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/金融系统/" title="金融系统">金融系统<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/随笔/" title="随笔">随笔<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/音视频/" title="音视频">音视频<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/CouchDB/" style="font-size: 10px;">CouchDB</a> <a href="/tags/DDD/" style="font-size: 14.55px;">DDD</a> <a href="/tags/Dubbo/" style="font-size: 12.73px;">Dubbo</a> <a href="/tags/ELK-Stack/" style="font-size: 15.45px;">ELK-Stack</a> <a href="/tags/HTTPS/" style="font-size: 10px;">HTTPS</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/JDK-concurrent/" style="font-size: 12.73px;">JDK-concurrent</a> <a href="/tags/JDK源码解析/" style="font-size: 12.73px;">JDK源码解析</a> <a href="/tags/Java/" style="font-size: 19.09px;">Java</a> <a href="/tags/KindEditor/" style="font-size: 10px;">KindEditor</a> <a href="/tags/Linux/" style="font-size: 10.91px;">Linux</a> <a href="/tags/MIT/" style="font-size: 10px;">MIT</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/SSO-单点登录/" style="font-size: 10px;">SSO,单点登录</a> <a href="/tags/Sharding-JDBC/" style="font-size: 12.73px;">Sharding-JDBC</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Spring扩展点/" style="font-size: 10px;">Spring扩展点</a> <a href="/tags/TCC-Transaction源码解析/" style="font-size: 10.91px;">TCC-Transaction源码解析</a> <a href="/tags/Tomcat/" style="font-size: 10.91px;">Tomcat</a> <a href="/tags/auth/" style="font-size: 10.91px;">auth</a> <a href="/tags/disruptor/" style="font-size: 14.55px;">disruptor</a> <a href="/tags/docker/" style="font-size: 11.82px;">docker</a> <a href="/tags/gRPC/" style="font-size: 11.82px;">gRPC</a> <a href="/tags/hexo/" style="font-size: 10.91px;">hexo</a> <a href="/tags/kubernates/" style="font-size: 10px;">kubernates</a> <a href="/tags/maven/" style="font-size: 11.82px;">maven</a> <a href="/tags/mybatis/" style="font-size: 10.91px;">mybatis</a> <a href="/tags/mysql/" style="font-size: 13.64px;">mysql</a> <a href="/tags/nginx/" style="font-size: 10.91px;">nginx</a> <a href="/tags/spring-boot/" style="font-size: 20px;">spring-boot</a> <a href="/tags/springboot/" style="font-size: 10px;">springboot</a> <a href="/tags/web/" style="font-size: 12.73px;">web</a> <a href="/tags/与你同行/" style="font-size: 10px;">与你同行</a> <a href="/tags/专题-分布式/" style="font-size: 17.27px;">专题-分布式</a> <a href="/tags/从零学Netty/" style="font-size: 10.91px;">从零学Netty</a> <a href="/tags/代理模式-工作总结-入职感受/" style="font-size: 10px;">代理模式,工作总结,入职感受</a> <a href="/tags/分布式-Dubbo/" style="font-size: 12.73px;">分布式 Dubbo</a> <a href="/tags/单例模式-懒加载/" style="font-size: 10px;">单例模式, 懒加载</a> <a href="/tags/实战分布式/" style="font-size: 11.82px;">实战分布式</a> <a href="/tags/年度总结/" style="font-size: 14.55px;">年度总结</a> <a href="/tags/我们的爱情/" style="font-size: 10px;">我们的爱情</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/汇总盘点推荐/" style="font-size: 10px;">汇总盘点推荐</a> <a href="/tags/爬虫-WebMagic/" style="font-size: 10px;">爬虫,WebMagic</a> <a href="/tags/电话面试/" style="font-size: 10px;">电话面试</a> <a href="/tags/研磨Kafka/" style="font-size: 14.55px;">研磨Kafka</a> <a href="/tags/秒杀/" style="font-size: 10px;">秒杀</a> <a href="/tags/自己写分布式组件系列/" style="font-size: 16.36px;">自己写分布式组件系列</a> <a href="/tags/跟我学RocketMQ/" style="font-size: 18.18px;">跟我学RocketMQ</a> <a href="/tags/跟我学zookeeper/" style="font-size: 10px;">跟我学zookeeper</a> <a href="/tags/金融系统/" style="font-size: 10.91px;">金融系统</a> <a href="/tags/随笔/" style="font-size: 15.45px;">随笔</a> <a href="/tags/音视频/" style="font-size: 10px;">音视频</a>
    </div>
  </div>


  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="TaXueWWL" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/spring-boot/" title="spring-boot">spring-boot<sup>38</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>37</sup></a></li>
			
		
			
				<li><a href="/tags/跟我学RocketMQ/" title="跟我学RocketMQ">跟我学RocketMQ<sup>25</sup></a></li>
			
		
			
				<li><a href="/tags/专题-分布式/" title="专题-分布式">专题-分布式<sup>19</sup></a></li>
			
		
			
				<li><a href="/tags/自己写分布式组件系列/" title="自己写分布式组件系列">自己写分布式组件系列<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/ELK-Stack/" title="ELK-Stack">ELK-Stack<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/随笔/" title="随笔">随笔<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/DDD/" title="DDD">DDD<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/disruptor/" title="disruptor">disruptor<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/年度总结/" title="年度总结">年度总结<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/研磨Kafka/" title="研磨Kafka">研磨Kafka<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/web/" title="web">web<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/JDK源码解析/" title="JDK源码解析">JDK源码解析<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/JDK-concurrent/" title="JDK-concurrent">JDK-concurrent<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/分布式-Dubbo/" title="分布式 Dubbo">分布式 Dubbo<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/gRPC/" title="gRPC">gRPC<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/maven/" title="maven">maven<sup>3</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="undefined" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p>  <br/>
			惟精惟一，允执厥中 朝闻道，夕死可矣</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/TaXueWWL" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		<a href="http://www.zhihu.com/people/TaXueWWL" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
		<a href="mailto:wuwenliangsn@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2022 
		
		<a href="/about" target="_blank" title="SnoWalker">SnoWalker</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"snowalker"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

<a href="https://github.com/TaXueWWL" target="_blank"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_white_ffffff.png" alt="Fork me on GitHub"></a>